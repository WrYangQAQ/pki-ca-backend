# PKI 小型 CA 系统｜前端接口对接文档（Vue）

> 说明：本文档在 v2.1 基础上修订，已严格对照当前 **6 个 Controller 源码** 与 **SecurityConfig 的接口权限**。
> Base URL：`http://localhost:8080`

---

## 0. 通用约定

- Content-Type：`application/json; charset=utf-8`
- 认证方式：JWT  
  - Header：`Authorization: Bearer <token>`
- 返回结构：
  - 大多数接口返回 `ApiResponse<T>`
  - 少数管理接口直接返回 `List<...>`（非 ApiResponse）：`GET /api/users`、`GET /api/logs`、`GET /api/certificates/{certId}/download`

### 0.1 ApiResponse 结构

```json
{
  "success": true,
  "message": "ok",
  "data": {}
}
```

```json
{
  "success": false,
  "message": e.getMessage(),
  "data": null
}
```

### 0.2 错误返回约定

- 业务校验失败：HTTP 200 + `success=false`
- 认证失败：HTTP 401
- 权限不足：HTTP 403
- 部分下载接口在 404 时返回空 body（非 ApiResponse）

---

## 1. 权限与接口总览

### 1.1 PermitAll（无需登录）

- `POST /api/users/register`
- `POST /api/users/auth/challenge`
- `POST /api/users/auth/login`
- `GET  /api/certificates/status?serialNumber=...`
- `GET  /api/certificates/{certId}/status`
- `GET  /api/certificates/{serialNumber}/verify`
- `GET  /api/crl`

### 1.2 USER / ADMIN（登录后可访问）

- `GET  /api/certificates/{certId}/download`
- `POST /api/certificates/apply-request`
- `POST /api/certificates/{serialNumber}/revoke-request`
- `GET  /api/certificates/my`
- `POST /api/certificates/csr/challenge`

### 1.3 ADMIN only（仅管理员）

- `GET  /api/certificates`
- `GET  /api/users`（返回 List）
- `GET  /api/logs`（返回 List）
- `GET  /api/certificates/apply-requests`
- `POST /api/certificates/apply-requests/{id}/approve`
- `POST /api/certificates/apply-requests/{id}/reject`
- `GET  /api/certificates/revoke-requests`
- `POST /api/certificates/revoke-requests/{id}/approve`
- `POST /api/certificates/revoke-requests/{id}/reject`
- `POST /api/certificates/issue`（旧接口）
- `POST /api/crl/revoke`（旧接口）

---

## 2. 用户接口（/api/users）

### 2.1 用户注册

**POST** `/api/users/register`

**Body（UserEntity，示例字段）**
```json
{
  "username": "alice",
  "loginPublicKey": "-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----",
  "role": "ROLE_USER"
}
```

**成功响应（ApiResponse<UserEntity>，示例）**
```json
{
  "success": true,
  "message": "ok",
  "data": {
    "userId": 3,
    "username": "alice",
    "loginPublicKey": "-----BEGIN PUBLIC KEY-----\n...",
    "role": "ROLE_USER",
    "registerTime": "2025-12-17T12:00:00"
  }
}
```

**失败响应**
```json
{ "success": false, "message": "用户名已存在", "data": null }
```

> 备注：UserEntity 可能还有其他字段（如 email 等），以你当前后端实体类为准；前端按后端实际要求传参即可。

---

### 2.2 获取登录 Challenge（PKI 登录 Step 1）

**POST** `/api/users/auth/challenge`

**Body（LoginRequest）**
```json
{ "username": "alice" }
```

**成功响应（ApiResponse<String>）**
```json
{ "success": true, "message": "ok", "data": "3fb68162ed804cea99b2b6525a1a70fb" }
```

---

### 2.3 PKI 登录（验签 + 返回 JWT）

**POST** `/api/users/auth/login`

**Body（LoginVerifyRequest）**
```json
{
  "username": "alice",
  "challenge": "3fb68162ed804cea99b2b6525a1a70fb",
  "signature": "Base64Signature"
}
```

**重要说明（与后端实现一致）**
- 后端实际用于验签的 message 是 **服务端缓存的 challenge**（而不是前端传入的 challenge 字段）
- challenge 验证成功后会被一次性消费

**成功响应（ApiResponse<String>，data 为 JWT）**
```json
{ "success": true, "message": "ok", "data": "eyJhbGciOi..." }
```

**失败响应（示例）**
```json
{ "success": false, "message": "challenge无效或已过期", "data": null }
```
```json
{ "success": false, "message": "签名验证失败", "data": null }
```

---

### 2.4 查询全部用户（管理员）

**GET** `/api/users`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**响应（注意：不是 ApiResponse，是 List<UserEntity>，示例）**
```json
[
  {
    "userId": 1,
    "username": "admin",
    "role": "ROLE_ADMIN",
    "registerTime": "2025-12-17T10:00:00"
  }
]
```

---

## 3. 证书接口（/api/certificates）

### 3.1 查询所有证书（管理员）

**GET** `/api/certificates`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**响应（ApiResponse<List<CertificateEntity>>，字段以实体为准）**
```json
{
  "success": true,
  "message": "ok",
  "data": [
    {
      "certId": 1,
      "serialNumber": "SN-1765607385557",
      "status": "有效",
      "validFrom": "2025-12-13T14:29:45.557",
      "validTo": "2026-12-13T14:29:45.557"
    }
  ]
}
```

---

### 3.2 查询本人证书（返回精简字段）

**GET** `/api/certificates/my`

**Header**
```
Authorization: Bearer <JWT>
```

**响应（ApiResponse<List<Map>>）**
```json
{
  "success": true,
  "message": "ok",
  "data": [
    {
      "serialNumber": "SN-1765607385557",
      "status": "有效",
      "validFrom": "2025-12-13T14:29:45.557",
      "validTo": "2026-12-13T14:29:45.557"
    }
  ]
}
```

---

### 3.3 按 certId 查询证书状态（公开）

**GET** `/api/certificates/{certId}/status`

**响应（ApiResponse<String>）**
```json
{ "success": true, "message": "ok", "data": "有效" }
```

---

### 3.4 按序列号查询证书状态（公开）

**GET** `/api/certificates/status?serialNumber=SN-xxxx`

**响应（ApiResponse<String>）**
```json
{ "success": true, "message": "ok", "data": "有效" }
```

---

### 3.5 按序列号验证证书（公开，返回更详细信息）

**GET** `/api/certificates/{serialNumber}/verify`

**成功响应（ApiResponse<Map>）**
```json
{
  "success": true,
  "message": "ok",
  "data": {
    "status": "有效",
    "validFrom": "2025-12-13T14:29:45.557",
    "validTo": "2026-12-13T14:29:45.557"
  }
}
```

**失败响应（示例）**
```json
{ "success": false, "message": "证书不存在", "data": null }
```
```json
{ "success": false, "message": "证书不可用，状态：已吊销", "data": null }
```

---

### 3.6 下载证书（登录后，权限受控）

**GET** `/api/certificates/{serialNumber}/download`

**Header**
```
Authorization: Bearer <JWT>
```

**成功响应**
- HTTP 200
- Header：`Content-Disposition: attachment; filename=certificate-{certId}.pem`
- Content-Type：`application/x-pem-file`
- Body：证书 PEM 字符串（非 ApiResponse）

**失败响应（当前实现）**
- 证书不存在：HTTP 404（无 JSON body）
- USER 下载他人证书：HTTP 403

---

### 3.7 获取 CSR Challenge（登录后）

**POST** `/api/certificates/csr/challenge`

**Header**
```
Authorization: Bearer <JWT>
```

**Body**
无

**响应（ApiResponse<String>）**
```json
{ "success": true, "message": "ok", "data": "csr-challenge-string" }
```

---

### 3.8 提交证书申请（CSR + Challenge 绑定）

**POST** `/api/certificates/apply-request`

**Header**
```
Authorization: Bearer <JWT>
```

**Body（CertificateApplyRequestDto）**
```json
{
  "csrPem": "-----BEGIN CERTIFICATE REQUEST-----\n...\n-----END CERTIFICATE REQUEST-----",
  "csrSignature": "Base64Signature"
}
```

**响应（ApiResponse<Long>，data 为 requestId）**
```json
{ "success": true, "message": "ok", "data": 12 }
```

**常见失败响应（示例）**
```json
{ "success": false, "message": "csrPem 不能为空", "data": null }
```
```json
{ "success": false, "message": "csrSignature 不能为空", "data": null }
```
```json
{ "success": false, "message": "CSR challenge 不存在，请重新获取", "data": null }
```
```json
{ "success": false, "message": "CSR challenge 无效或已过期", "data": null }
```

---

## 4. 证书申请审批（管理员｜/api/certificates/apply-requests）

### 4.1 查询待审批申请列表

**GET** `/api/certificates/apply-requests`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**响应（ApiResponse<List<CertificateApplicationRequestEntity>>，字段以实体为准）**
```json
{
  "success": true,
  "message": "ok",
  "data": [
    {
      "requestId": 12,
      "status": "PENDING",
      "requestTime": "2025-12-17T12:10:00"
    }
  ]
}
```

---

### 4.2 审批申请并签发证书

**POST** `/api/certificates/apply-requests/{id}/approve`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**Body**
无

**成功响应（ApiResponse<Long>，data 为 certId）**
```json
{ "success": true, "message": "ok", "data": 5 }
```

**失败响应（示例）**
```json
{ "success": false, "message": "证书申请不存在", "data": null }
```
```json
{ "success": false, "message": "该申请不是待审批状态", "data": null }
```

---

### 4.3 拒绝证书申请

**POST** `/api/certificates/apply-requests/{id}/reject`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**Body（RejectRequestDto）**
```json
{ "reason": "信息不完整" }
```

**响应（ApiResponse<String>）**
```json
{ "success": true, "message": "ok", "data": "已拒绝该证书申请" }
```

---

## 5. 证书吊销流程（RA 审批模式）

### 5.1 用户提交吊销申请

**POST** `/api/certificates/{serialNumber}/revoke-request`

**Header**
```
Authorization: Bearer <JWT>
```

**Body（Map）**
```json
{ "reason": "keyCompromise" }
```

**响应（ApiResponse<Long>，data 为 requestId）**
```json
{ "success": true, "message": "ok", "data": 21 }
```

**失败响应（示例）**
```json
{ "success": false, "message": "证书不存在", "data": null }
```
```json
{ "success": false, "message": "无权吊销该证书", "data": null }
```
```json
{ "success": false, "message": "当前证书状态不可申请吊销", "data": null }
```
```json
{ "success": false, "message": "请填写吊销原因", "data": null }
```

---

### 5.2 管理员查询吊销申请列表

**GET** `/api/certificates/revoke-requests`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**响应（ApiResponse<List<CertificateRevocationRequestEntity>>，字段以实体为准）**
```json
{
  "success": true,
  "message": "ok",
  "data": [
    {
      "requestId": 21,
      "status": "PENDING",
      "reason": "keyCompromise",
      "requestTime": "2025-12-17T12:20:00"
    }
  ]
}
```

---

### 5.3 管理员通过吊销申请（真正执行吊销 + 写入 CRL）

**POST** `/api/certificates/revoke-requests/{id}/approve`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**Body**
无

**响应（ApiResponse<String>）**
```json
{ "success": true, "message": "ok", "data": "证书已成功吊销" }
```

---

### 5.4 管理员拒绝吊销申请

**POST** `/api/certificates/revoke-requests/{id}/reject`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**Body（RejectRequestDto）**
```json
{ "reason": "理由不充分" }
```

**响应（ApiResponse<String>）**
```json
{ "success": true, "message": "ok", "data": "已拒绝该吊销申请" }
```

---

## 6. CRL 接口（/api/crl）

### 6.1 查询吊销列表（公开）

**GET** `/api/crl`

**响应（ApiResponse<List<CRLEntity>>，示例）**
```json
{
  "success": true,
  "message": "ok",
  "data": [
    {
      "crlId": 1,
      "revokeTime": "2025-12-17T12:30:00",
      "reason": "keyCompromise"
    }
  ]
}
```

---

### 6.2 旧吊销接口（管理员｜不推荐使用）

**POST** `/api/crl/revoke`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**Body**
```json
{
  "certId": 1,
  "reason": "keyCompromise"
}
```

**响应（ApiResponse<CRLEntity>）**
```json
{
  "success": true,
  "message": "ok",
  "data": {
    "crlId": 1,
    "revokeTime": "2025-12-17T12:30:00",
    "reason": "keyCompromise"
  }
}
```

---

## 7. 旧签发接口（管理员｜不推荐使用）

**POST** `/api/certificates/issue?userId=3`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**Body（CertificateEntity，示例）**
```json
{
  "serialNumber": "SN-20251214-001",
  "certPEM": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",
  "validFrom": "2025-12-14T00:00:00",
  "validTo": "2026-12-14T00:00:00"
}
```

---

## 8. 操作日志（/api/logs｜管理员）

**GET** `/api/logs`

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**响应（注意：不是 ApiResponse，是 List<OperationLogEntity>，示例）**
```json
[
  {
    "logId": 1,
    "operator": "admin",
    "action": "申请证书（CSR + Challenge 绑定）",
    "target": "CertificateRequest",
    "actionTime": "2025-12-17T12:10:01",
    "details": "requestId=12"
  }
]
```

---

## 9. 前端（Vue/Axios）对接建议

- 请求拦截器：自动加 `Authorization`（若 token 存在）
- 响应拦截器：统一处理
  - 401：清 token → 跳登录页
  - 403：提示“权限不足”
  - 200 且 `success=false`：提示 `message`

---

文档版本：**v2.2（已按 Controller 源码 + SecurityConfig 实际接口权限修订）**

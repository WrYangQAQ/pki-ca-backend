<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKI证书管理系统 - 管理员</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .glass-effect{background:rgba(255,255,255,0.9);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.6)}
        .input-focus{transition:all .2s ease}
        .btn-hover{transition:all .2s ease}
        .btn-hover:hover{transform:translateY(-1px)}
    </style>
</head>
<body class="bg-gradient-to-br from-sky-100 via-sky-200 to-sky-300 min-h-screen flex items-center justify-center p-4">
<div class="relative z-10 w-full max-w-7xl">
    <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-white bg-opacity-30 rounded-full mb-4">
            <i class="fas fa-user-shield text-3xl text-blue-700"></i>
        </div>
        <h1 class="text-3xl font-bold text-slate-900 mb-2">管理员控制台</h1>
        <p id="welcomeText" class="text-slate-700"></p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="glass-effect rounded-2xl p-8 shadow-2xl lg:col-span-12">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-sm font-medium">申请与吊销列表</div>
                <button id="refreshRequests" class="btn-hover px-4 py-2 bg-sky-600 text-white rounded-lg">刷新</button>
            </div>
            <div id="combinedList" class="space-y-3"></div>
        </div>
        <div class="glass-effect rounded-2xl p-8 shadow-2xl lg:col-span-6">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-sm font-medium" id="userCrlLabel">用户列表</div>
                <div class="flex gap-2">
                    <input id="userFilter" type="text" class="input-focus px-3 py-2 bg-white border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400" placeholder="按用户名搜索">
                    <button id="toggleUserCRL" class="btn-hover px-4 py-2 bg-white border border-slate-300 text-slate-900 rounded-lg">显示CRL</button>
                    <button id="refreshUsers" class="btn-hover px-4 py-2 bg-sky-600 text-white rounded-lg">刷新</button>
                </div>
            </div>
            <div id="usersList" class="space-y-3"></div>
            <div id="crlList" class="space-y-3 hidden"></div>
        </div>
        <div class="glass-effect rounded-2xl p-8 shadow-2xl lg:col-span-6">
            <div class="flex items-center justify-between mb-4">
                <div class="bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-sm font-medium">操作日志</div>
                <button id="refreshLogs" class="btn-hover px-4 py-2 bg-sky-600 text-white rounded-lg">刷新</button>
            </div>
            <div id="logsList" class="space-y-3"></div>
        </div>
    </div>

    <div id="statusMessage" class="mt-6 hidden">
        <div class="flex items-center p-3 rounded-lg">
            <i id="statusIcon" class="fas mr-2 text-slate-600"></i>
            <span id="statusText" class="text-slate-800"></span>
        </div>
    </div>
</div>

<script>
    class AdminConsole {
        constructor(){
            this.baseURL='http://localhost:8080';
            this.jwt=sessionStorage.getItem('pki_jwt');
            this.username=sessionStorage.getItem('pki_username');
            this.init();
        }
        init(){
            if(!this.jwt){window.location.href='./login.html';return}
            const welcome=document.getElementById('welcomeText');
            if(welcome&&this.username)welcome.textContent=`欢迎，${this.username}`;
            this.applyRequests=[];
            this.revokeRequests=[];
            this.users=[];
            this.crl=[];
            this.showCRL=false;
            document.getElementById('refreshRequests').addEventListener('click',()=>this.loadCombined());
            const uf=document.getElementById('userFilter');
            if(uf) uf.addEventListener('input',()=>this.renderUsers());
            const tgl=document.getElementById('toggleUserCRL');
            if(tgl) tgl.addEventListener('click',()=>this.toggleUserCRL());
            document.getElementById('refreshUsers').addEventListener('click',()=>this.loadUsers());
            document.getElementById('refreshLogs').addEventListener('click',()=>this.loadLogs());
            this.loadCombined();
            this.loadUsers();
            this.loadCRL();
            this.loadLogs();
        }
        showStatus(message,type){
            const statusDiv=document.getElementById('statusMessage');
            const icon=document.getElementById('statusIcon');
            const text=document.getElementById('statusText');
            statusDiv.classList.remove('hidden');
            icon.classList.remove('fa-check-circle','fa-exclamation-circle','fa-info-circle');
            if(type==='success')icon.classList.add('fa-check-circle');
            else if(type==='error')icon.classList.add('fa-exclamation-circle');
            else icon.classList.add('fa-info-circle');
            text.textContent=message;
        }
        async loadCombined(){
            try{
                const [applyResp, revokeResp] = await Promise.all([
                    fetch(`./api/certificates/apply-requests`, { headers: { 'Authorization': `Bearer ${this.jwt}` } }),
                    fetch(`./api/certificates/revoke-requests`, { headers: { 'Authorization': `Bearer ${this.jwt}` } })
                ]);
                const applyData = await applyResp.json();
                const revokeData = await revokeResp.json();
                this.applyRequests = (applyData && applyData.success && Array.isArray(applyData.data)) ? applyData.data : [];
                this.revokeRequests = (revokeData && revokeData.success && Array.isArray(revokeData.data)) ? revokeData.data : [];
                this.renderCombined();
            }catch(e){ this.applyRequests=[]; this.revokeRequests=[]; this.renderCombined(); }
        }
        renderCombined(){
            const container = document.getElementById('combinedList');
            container.innerHTML='';
            const normalizeTime = t => new Date(t || 0).getTime();
            const rows = [];
            (this.applyRequests||[]).forEach(r=>{ rows.push({ type:'apply', requestId:r.requestId, status:r.status, requestTime:r.requestTime, username:r.username||'', reason:'', allow:String(r.status||'').toUpperCase()==='PENDING' }); });
            (this.revokeRequests||[]).forEach(r=>{ rows.push({ type:'revoke', requestId:r.requestId, status:r.status, requestTime:r.requestTime, username:r.username||'', reason:r.reason||'', allow:String(r.status||'').toUpperCase()==='PENDING' }); });
            const items = rows.sort((a,b)=> normalizeTime(b.requestTime) - normalizeTime(a.requestTime));
            if(items.length===0){ container.innerHTML = '<div class="text-slate-600 text-sm">暂无申请或吊销请求</div>'; return; }
            items.forEach(x=>{
                const row=document.createElement('div');
                row.className='border border-slate-200 rounded-lg p-4 bg-white';
                const label = x.type==='apply' ? '签发申请' : '吊销申请';
                row.innerHTML=`
                        <div class='flex justify-between items-center'>
                            <div>
                                <div class='text-slate-900 font-semibold'>${label} #${x.requestId}</div>
                                <div class='text-slate-600 text-sm'>用户：${x.username || '-'}</div>
                                ${x.type==='revoke' ? `<div class='text-slate-600 text-sm'>原因：${x.reason || '-'}</div>` : ''}
                                <div class='text-slate-600 text-sm'>时间：${this.fmt(x.requestTime) || '-'}</div>
                                <div class='text-slate-600 text-sm'>状态：${x.status || '-'}</div>
                            </div>
                            <div class='flex gap-2'>
                                <button class='px-3 py-2 bg-sky-600 text-white rounded ${x.allow?'':'opacity-50 cursor-not-allowed'}' data-action='approve'>同意</button>
                                <button class='px-3 py-2 bg-red-600 text-white rounded ${x.allow?'':'opacity-50 cursor-not-allowed'}' data-action='reject'>拒绝</button>
                            </div>
                        </div>`;
                const approveBtn = row.querySelector("[data-action='approve']");
                const rejectBtn = row.querySelector("[data-action='reject']");
                if(x.allow){
                    approveBtn.addEventListener('click',()=>this.approveItem(x.type,x.requestId));
                    rejectBtn.addEventListener('click',()=>this.rejectItem(x.type,x.requestId));
                }
                container.appendChild(row);
            });
        }
        async approveItem(type,id){
            try{
                const url = type==='apply' ? `./api/certificates/apply-requests/${id}/approve` : `./api/certificates/revoke-requests/${id}/approve`;
                const resp = await fetch(url,{method:'POST',headers:{'Authorization':`Bearer ${this.jwt}`}});
                const data = await resp.json();
                if(data && data.success){ this.showStatus('已同意', 'success'); await this.loadCombined(); } else { this.showStatus((data&&data.message)||'操作失败','error'); }
            }catch(e){ this.showStatus('请求失败','error'); }
        }
        async rejectItem(type,id){
            try{
                const url = type==='apply' ? `./api/certificates/apply-requests/${id}/reject` : `./api/certificates/revoke-requests/${id}/reject`;
                const resp = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${this.jwt}`},body: JSON.stringify({ reason: '不通过' })});
                const data = await resp.json();
                if(data && data.success){ this.showStatus('已拒绝', 'success'); await this.loadCombined(); } else { this.showStatus((data&&data.message)||'操作失败','error'); }
            }catch(e){ this.showStatus('请求失败','error'); }
        }

        async loadUsers(){
            try{
                const resp = await fetch(`./api/users`, { headers: { 'Authorization': `Bearer ${this.jwt}` } });
                const data = await resp.json();
                this.users = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : []);
                this.renderUsers();
            }catch(e){ this.users=[]; this.renderUsers(); }
        }
        renderUsers(){
            const list = document.getElementById('usersList');
            list.innerHTML='';
            const q = (document.getElementById('userFilter')?.value || '').trim().toLowerCase();
            const items = (this.users||[]).filter(u=> !q || String(u.username||'').toLowerCase().includes(q));
            if(items.length===0){ list.innerHTML = '<div class="text-slate-600 text-sm">暂无用户</div>'; return; }
            items.forEach(u=>{
                const row = document.createElement('div');
                row.className='border border-slate-200 rounded-lg p-3 bg-white';
                row.innerHTML=`<div class='flex justify-between items-center'><div><div class='text-slate-900 font-medium'>${u.username||'-'}</div><div class='text-slate-600 text-sm'>角色：${u.role||'-'}</div></div><div class='text-slate-700 text-sm'>注册：${this.fmt(u.registerTime)||'-'}</div></div>`;
                list.appendChild(row);
            });
        }

        async loadCRL(){
            try{
                const resp = await fetch(`./api/crl`);
                const data = await resp.json();
                this.crl = (data && data.success && Array.isArray(data.data)) ? data.data : [];
                this.renderCRL();
            }catch(e){ this.crl=[]; this.renderCRL(); }
        }

        renderCRL(){
            const list = document.getElementById('crlList');
            list.innerHTML='';
            const items = this.crl || [];
            if(items.length===0){ list.innerHTML = '<div class="text-slate-600 text-sm">暂无吊销记录</div>'; return; }
            items.forEach(x=>{
                const row = document.createElement('div');
                row.className='border border-slate-200 rounded-lg p-3 bg-white';
                row.innerHTML=`<div class='flex justify-between items-center'><div><div class='text-slate-900 font-medium'>CRL ID：${x.crlId??x.crlid??'-'}</div><div class='text-slate-600 text-sm'>原因：${x.reason||'-'}</div></div><div class='text-slate-700 text-sm'>时间：${this.fmt(x.revokeTime)||'-'}</div></div>`;
                list.appendChild(row);
            });
        }

        toggleUserCRL(){
            this.showCRL = !this.showCRL;
            const usersList = document.getElementById('usersList');
            const crlList = document.getElementById('crlList');
            const label = document.getElementById('userCrlLabel');
            const tgl = document.getElementById('toggleUserCRL');
            if(this.showCRL){
                usersList.classList.add('hidden');
                crlList.classList.remove('hidden');
                label.textContent = 'CRL 列表';
                tgl.textContent = '显示用户';
            }else{
                crlList.classList.add('hidden');
                usersList.classList.remove('hidden');
                label.textContent = '用户列表';
                tgl.textContent = '显示CRL';
            }
        }

        async loadLogs(){
            try{
                const resp = await fetch(`./api/logs`, { headers: { 'Authorization': `Bearer ${this.jwt}` } });
                const data = await resp.json();
                const list = document.getElementById('logsList');
                list.innerHTML='';
                const items = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : []);
                if(items.length===0){ list.innerHTML = '<div class="text-slate-600 text-sm">暂无日志</div>'; return; }
                items.forEach(l=>{
                    const row = document.createElement('div');
                    row.className='border border-slate-200 rounded-lg p-3 bg-white';
                    row.innerHTML=`<div class='flex justify之间 items-center'><div><div class='text-slate-900 font-medium'>${l.action||'-'}</div><div class='text-slate-600 text-sm'>目标：${l.target||'-'} | 操作人：${l.operator||'-'}</div></div><div class='text-slate-700 text-sm'>时间：${this.fmt(l.actionTime)||'-'}</div></div>`;
                    list.appendChild(row);
                });
            }catch(e){ document.getElementById('logsList').innerHTML = '<div class="text-slate-600 text-sm">加载失败</div>'; }
        }

        fmt(s){
            if(!s) return '';
            const d=new Date(s);
            if(isNaN(d.getTime())) return s;
            const yy=String(d.getFullYear()).slice(-2);
            const MM=String(d.getMonth()+1).padStart(2,'0');
            const dd=String(d.getDate()).padStart(2,'0');
            const hh=String(d.getHours()).padStart(2,'0');
            const mm=String(d.getMinutes()).padStart(2,'0');
            const ss=String(d.getSeconds()).padStart(2,'0');
            return `${yy}年${MM}月${dd}日：${hh}时${mm}分${ss}秒`;
        }
    }
    document.addEventListener('DOMContentLoaded',()=>{new AdminConsole()});
</script>
</body>
</html>

# PKI CA 系统前端接口对接文档（Vue 前端）

> 本文档面向前端开发人员，作为 **唯一接口契约文档** 使用。
> 所有接口均基于 RESTful 风格，数据格式统一为 JSON（证书下载接口除外）。

---

## 1. 通用约定

### 1.1 基础信息
- 后端 Base URL：`http://localhost:8080`
- 编码：UTF-8
- 数据格式：`application/json`

### 1.2 通用响应结构

```json
{
  "success": true,
  "message": "ok",
  "data": {}
}
```

| 字段 | 类型 | 说明 |
|---|---|---|
| success | boolean | 是否成功 |
| message | string | 提示信息 |
| data | any | 实际返回数据 |

### 1.3 登录态说明（JWT）

登录成功后，后端返回 JWT：

```json
{
  "success": true,
  "data": "eyJhbGciOiJIUzI1NiJ9..."
}
```

前端需保存该 Token，并在后续请求 Header 中携带：

```
Authorization: Bearer <JWT>
```

---

## 2. PKI 登录接口

### 2.1 获取 Challenge

**接口说明**  
获取一次性 challenge，用于 PKI 登录签名，防止重放攻击。

**请求**
```
POST /api/users/auth/challenge
```

**Query 参数**
| 参数 | 类型 | 说明 |
|---|---|---|
| username | string | 用户名 |

**成功响应**
```json
{
  "success": true,
  "data": "a92f5b1eb1a84bb18a494adc4927a036"
}
```

**失败响应**
```json
{
  "success": false,
  "message": "用户不存在"
}
```

---

### 2.2 PKI 登录（签名验证）

**接口说明**  
前端使用私钥对 challenge 签名，后端验签成功后返回 JWT。

**请求**
```
POST /api/users/auth/login
```

**请求体**
```json
{
  "username": "Alan",
  "challenge": "a92f5b1e...",
  "signature": "Base64EncodedSignature"
}
```

**成功响应**
```json
{
  "success": true,
  "data": "eyJhbGciOiJIUzI1NiJ9..."
}
```

**失败响应**
```json
{
  "success": false,
  "message": "签名验证失败"
}
```

---

## 3. 证书申请与查询

### 3.1 申请证书（USER）

**接口说明**  
登录用户向 CA 提交证书申请。

**请求**
```
POST /api/certificates/apply
```

**Header**
```
Authorization: Bearer <JWT>
```

**成功响应**
```json
{
  "success": true,
  "data": 12
}
```

---

### 3.2 查询我的证书（USER）

```
GET /api/certificates
```

**成功响应**
```json
{
  "success": true,
  "data": [
    {
      "certId": 1,
      "serialNumber": "SN-20251213-001",
      "status": "有效",
      "validFrom": "2025-12-13T00:00:00",
      "validTo": "2026-12-13T00:00:00"
    }
  ]
}
```

---

## 4. 管理员接口（ADMIN）

### 4.1 查询待审批证书申请

```
GET /api/certificates/requests
```

**Header**
```
Authorization: Bearer <ADMIN_JWT>
```

**成功响应**
```json
{
  "success": true,
  "data": [
    {
      "requestId": 1,
      "username": "Eve",
      "status": "PENDING",
      "requestTime": "2025-12-13T12:42:45"
    }
  ]
}
```

---

### 4.2 审批证书申请

```
POST /api/certificates/requests/{requestId}/approve
```

**成功响应**
```json
{
  "success": true,
  "data": {
    "certId": 5,
    "serialNumber": "SN-20251213-005"
  }
}
```

---

## 5. 证书下载

### 5.1 下载证书（PEM）

```
GET /api/certificates/{certId}/download
```

**Header**
```
Authorization: Bearer <JWT>
```

**成功响应**
- HTTP 200
- 文件内容（PEM）：
```
-----BEGIN CERTIFICATE-----
MIIC...
-----END CERTIFICATE-----
```

---

## 6. 前端安全注意事项

- 前端 **不保存私钥**
- 私钥仅用于本地签名 challenge
- JWT 仅作为会话凭证，不等价于身份认证
- 所有关键接口必须携带 JWT

---

## 7. 对接建议（Vue）

- 使用 Axios 统一封装请求
- 使用拦截器自动注入 JWT
- 对 401 / 403 状态码统一跳转登录页

---

文档版本：v1.1  


---

## 附录 A：统一错误返回规范（前端必须遵守）

### A.1 401 Unauthorized（未登录 / 登录失效）

**触发场景**
- 未携带 JWT 访问受保护接口
- JWT 过期、伪造、解析失败

**HTTP 状态码**
401

**返回 JSON**
```json
{
  "success": false,
  "message": "未登录或登录已失效",
  "data": null
}
```

**前端处理建议**
- 清空本地 JWT
- 跳转登录页面

---

### A.2 403 Forbidden（权限不足）

**触发场景**
- USER 访问 ADMIN 接口
- USER 尝试访问或下载不属于自己的证书

**HTTP 状态码**
403

**返回 JSON**
```json
{
  "success": false,
  "message": "权限不足，无法访问该资源",
  "data": null
}
```

**前端处理建议**
- 保持当前登录态
- 弹出权限不足提示（不跳转登录）

---

### A.3 业务错误（逻辑校验失败）

**HTTP 状态码**
200

**返回 JSON**
```json
{
  "success": false,
  "message": "业务错误说明",
  "data": null
}
```

**说明**
- 参数非法
- 状态不允许（如重复申请证书、重复审批）
- 签名验证失败等

---

## 附录 B：前端统一错误处理建议（Vue）

- 使用 Axios 封装统一请求实例
- 请求拦截器中自动注入 JWT
- 响应拦截器中统一处理错误：

| HTTP 状态码 | 处理建议 |
|------------|----------|
| 401 | 清空 JWT，跳转登录页 |
| 403 | 弹出权限不足提示 |
| 200 + success=false | 显示业务错误信息 |

---
